/* Optimized JavaScript for Business Website */
/* Generated by Theme Editor v2.0 */

(function() {
  'use strict';
  
  // Mobile menu toggle
  function initMobileMenu() {
    const mobileMenuButton = document.querySelector('button[onclick="toggleMobileMenu()"]');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (mobileMenuButton && mobileMenu) {
      // Remove inline onclick and add event listener
      mobileMenuButton.removeAttribute('onclick');
      mobileMenuButton.addEventListener('click', function() {
        if (mobileMenu.style.display === 'none' || mobileMenu.style.display === '') {
          mobileMenu.style.display = 'block';
        } else {
          mobileMenu.style.display = 'none';
        }
      });
    }
  }
  
  // Navigation visibility based on screen size
  function updateNavigation() {
    const desktopNav = document.querySelector('nav');
    const desktopCTAs = document.querySelector('div[style*="display: none; align-items: center"]');
    const mobileButton = document.querySelector('button[onclick="toggleMobileMenu()"]');
    
    if (!desktopNav || !desktopCTAs || !mobileButton) return;
    
    const isDesktop = window.matchMedia('(min-width: 768px)').matches;
    
    if (isDesktop) {
      desktopNav.style.display = 'flex';
      desktopCTAs.style.display = 'flex';
      mobileButton.style.display = 'none';
    } else {
      desktopNav.style.display = 'none';
      desktopCTAs.style.display = 'none';
      mobileButton.style.display = 'block';
    }
  }
  
  // Smooth scrolling for anchor links
  function initSmoothScrolling() {
    const links = document.querySelectorAll('a[href^="#"]');
    
    links.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  }
  
  // Intersection Observer for animations
  function initAnimations() {
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate-slide-up');
          }
        });
      }, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      });
      
      // Observe all cards and sections
      document.querySelectorAll('.card, section').forEach(el => {
        observer.observe(el);
      });
    }
  }
  
  // Form handling
  function initForms() {
    const leadForm = document.getElementById('leadMagnetForm');
    
    if (leadForm) {
      leadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const nameInput = document.getElementById('leadName');
        const emailInput = document.getElementById('leadEmail');
        const companyInput = document.getElementById('leadCompany');
        const projectIdInput = document.getElementById('leadProjectId') || document.getElementById('leadProjectIdParam');
        const messageDiv = document.getElementById('formMessage');
        const submitButton = leadForm.querySelector('button[type="submit"]');
        
        if (!nameInput || !emailInput) return;
        
        const originalButtonText = submitButton.innerHTML;
        submitButton.innerHTML = 'Sending...';
        submitButton.disabled = true;
        
        const formData = {
          name: nameInput.value,
          email: emailInput.value,
          company: companyInput ? companyInput.value : '',
          projectId: projectIdInput ? projectIdInput.value : undefined
        };
        
        try {
          // Get API URL from environment variable or fallback to current domain
          const apiUrl = typeof window !== 'undefined' && (window as any).ENV?.NEXT_PUBLIC_API_URL 
            ? (window as any).ENV.NEXT_PUBLIC_API_URL 
            : '';
          
          const endpoint = apiUrl ? `${apiUrl}/api/leads` : '/api/leads';
          
          console.log('[LEAD FORM] Submitting to:', endpoint);
          
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData),
            mode: 'cors', // Enable CORS for cross-origin requests
          });
          
          if (response.ok) {
            const result = await response.json();
            if (messageDiv) {
              messageDiv.style.display = 'block';
              messageDiv.style.color = 'green';
              messageDiv.textContent = 'Thank you! Your information has been submitted.';
            }
            leadForm.reset();
            
            console.log('[LEAD FORM] Success:', result);
          } else {
            throw new Error('Submission failed');
          }
        } catch (error) {
          console.error('[LEAD FORM] Error submitting form:', error);
          if (messageDiv) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = 'red';
            messageDiv.textContent = 'Something went wrong. Please try again.';
          }
        } finally {
          submitButton.innerHTML = originalButtonText;
          submitButton.disabled = false;
        }
      });
    }
  }
  
  // Performance optimization
  function optimizePerformance() {
    // Lazy load images
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            imageObserver.unobserve(img);
          }
        });
      });
      
      document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
      });
    }
    
    // Preload critical resources
    const criticalLinks = document.querySelectorAll('link[rel="preload"]');
    criticalLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href) {
        const linkElement = document.createElement('link');
        linkElement.rel = 'stylesheet';
        linkElement.href = href;
        document.head.appendChild(linkElement);
      }
    });
  }
  
  // Initialize everything when DOM is ready
  function init() {
    initMobileMenu();
    updateNavigation();
    initSmoothScrolling();
    initAnimations();
    initForms();
    optimizePerformance();
    
    // Listen for resize events
    window.addEventListener('resize', updateNavigation);
    
    // Add global toggle function for backward compatibility
    window.toggleMobileMenu = function() {
      const menu = document.getElementById('mobileMenu');
      if (menu) {
        if (menu.style.display === 'none' || menu.style.display === '') {
          menu.style.display = 'block';
        } else {
          menu.style.display = 'none';
        }
      }
    };
  }
  
  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();